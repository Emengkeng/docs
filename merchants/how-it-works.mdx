---
title: "How It Works"
description: "Understanding the subscription flow from merchant perspective"
---

## The Complete Flow

Let's walk through what happens when a user subscribes to your service.

### 1. User Arrives at Your Website

Your potential customer visits your pricing page and clicks "Subscribe."
```html
<!-- Your pricing page -->
<button onclick="subscribe()">
  Subscribe to Premium - $9.99/month
</button>
```

### 2. You Create a Checkout Session

Your backend calls our API to create a checkout session:

<CodeGroup>
```javascript Node.js
const eventop = require('@eventop/sdk');

app.post('/create-subscription', async (req, res) => {
  const session = await eventop.checkout.create({
    merchantWallet: process.env.MERCHANT_WALLET,
    planId: 'premium-monthly',
    customerEmail: req.user.email,
    customerId: req.user.id, // Your internal user ID
    successUrl: 'https://yourdomain.com/success',
    cancelUrl: 'https://yourdomain.com/pricing',
    metadata: {
      userId: req.user.id,
      source: 'pricing_page'
    }
  });
  
  res.redirect(session.url);
});
```
```python Python
from eventop import Client

@app.route('/create-subscription', methods=['POST'])
def create_subscription():
    client = Client(api_key=os.environ['EVENTOP_API_KEY'])
    
    session = client.checkout.create(
        merchant_wallet=os.environ['MERCHANT_WALLET'],
        plan_id='premium-monthly',
        customer_email=current_user.email,
        customer_id=str(current_user.id),
        success_url='https://yourdomain.com/success',
        cancel_url='https://yourdomain.com/pricing',
        metadata={
            'user_id': current_user.id,
            'source': 'pricing_page'
        }
    )
    
    return redirect(session.url)
```
```php PHP
<?php
use Eventop\Client;

$client = new Client([
    'api_key' => $_ENV['EVENTOP_API_KEY']
]);

$session = $client->checkout->create([
    'merchantWallet' => $_ENV['MERCHANT_WALLET'],
    'planId' => 'premium-monthly',
    'customerEmail' => $user->email,
    'customerId' => $user->id,
    'successUrl' => 'https://yourdomain.com/success',
    'cancelUrl' => 'https://yourdomain.com/pricing',
    'metadata' => [
        'userId' => $user->id,
        'source' => 'pricing_page'
    ]
]);

header('Location: ' . $session->url);
?>
```

</CodeGroup>

**What you get back:**
```json
{
  "sessionId": "session_1a2b3c4d",
  "url": "https://checkout.eventop.xyz/session_1a2b3c4d",
  "expiresAt": "2024-12-09T10:30:00Z"
}
```

### 3. User Lands on Our Checkout Page

The user is redirected to our hosted checkout page at `checkout.eventop.xyz`.

<Frame>
  <img src="/images/checkout-page.png" alt="Checkout Page" />
</Frame>

The page shows:
- Your company name and logo (from merchant profile)
- Plan details and pricing
- Customer's email address
- Call-to-action to continue

### 4. We Detect User's Status

Our checkout page automatically detects if the user:

<Tabs>
  <Tab title="Has Our App">
    ‚úÖ **Best case**: User already has the Eventop mobile app
    
    - We immediately deep link to the app
    - User approves subscription with one tap
    - Returns to your site in seconds
  </Tab>
  
  <Tab title="No App Installed">
    üì± **Most common**: User needs to download the app
    
    - We show app download links (iOS/Android)
    - User downloads and creates account (2 minutes)
    - Returns to your site and completes checkout
    - Next time, they'll be in the "Has Our App" flow
  </Tab>
</Tabs>

### 5. User Completes Subscription in App

<Steps>
  <Step title="App Opens with Deep Link">
```
    eventop://subscribe?sessionId=session_1a2b3c4d
```
    
    The app loads the checkout session and displays:
    - Your company name
    - Plan details
    - Customer's email
    - Current wallet balance
  </Step>
  
  <Step title="Balance Check">
    The app automatically checks if the user has sufficient balance (typically 3 months of subscription fees as a buffer).
    
    - ‚úÖ **Sufficient**: Proceeds to Step 3
    - ‚ùå **Insufficient**: Prompts user to add funds first
  </Step>
  
  <Step title="On-Chain Transaction">
    User taps "Confirm Subscription" and approves the blockchain transaction.
    
    This creates:
    - A subscription PDA (Program Derived Address)
    - Links their subscription wallet to your merchant wallet
    - Registers the billing interval
  </Step>
  
  <Step title="Session Completion">
    The app calls our backend to complete the checkout session:
```javascript
    POST /api/checkout/{sessionId}/complete
    {
      "subscriptionPda": "ABC123...",
      "userWallet": "7xKXtg2...",
      "signature": "5j7Km..."
    }
```
  </Step>
</Steps>

### 6. You Receive a Webhook

Immediately after subscription creation, we send a webhook to your endpoint:
```json
{
  "event": "subscription.created",
  "timestamp": 1701234567890,
  "data": {
    "sessionId": "session_1a2b3c4d",
    "subscriptionId": "ABC123...",
    "customer": {
      "email": "user@example.com",
      "customerId": "user_123",
      "walletAddress": "7xKXtg2CW87d97TXJSDpbD5jBkheTqA83TZRuJosgAsU"
    },
    "plan": {
      "planId": "premium-monthly",
      "planName": "Premium Plan",
      "amount": "9990000", // 9.99 USDC (6 decimals)
      "interval": "2592000" // 30 days in seconds
    },
    "metadata": {
      "userId": "user_123",
      "source": "pricing_page"
    }
  }
}
```

<Warning>
  Always verify webhook signatures! See [Webhook Security](/integration/webhooks#verifying-webhook-signatures).
</Warning>

**Your webhook handler should:**
```javascript
app.post('/webhooks/eventop', async (req, res) => {
  // 1. Verify signature
  if (!verifySignature(req.body, req.headers['x-webhook-signature'])) {
    return res.status(401).send('Invalid signature');
  }
  
  // 2. Process the event
  const { event, data } = req.body;
  
  if (event === 'subscription.created') {
    // Grant access to your service
    await db.users.update({
      id: data.customer.customerId,
      subscriptionStatus: 'active',
      subscriptionId: data.subscriptionId,
      walletAddress: data.customer.walletAddress
    });
    
    // Send welcome email
    await sendEmail(data.customer.email, 'Welcome to Premium!');
  }
  
  // 3. Return 200 quickly
  res.json({ received: true });
});
```

### 7. User Returns to Your Site

The user is redirected back to your `successUrl`:
```
https://yourdomain.com/success?session_id=session_1a2b3c4d
```

Your success page can:
- Display a confirmation message
- Show next steps
- Fetch subscription details from your database
- Provide access to premium features

**Example success page:**
```javascript
// /success page
app.get('/success', async (req, res) => {
  const { session_id } = req.query;
  
  // Optional: Verify session with our API
  const session = await eventop.checkout.getSession(session_id);
  
  if (session.status === 'completed') {
    res.render('success', {
      planName: session.plan.planName,
      customerEmail: session.customer.email
    });
  } else {
    res.redirect('/pricing');
  }
});
```

---

## Recurring Payments

After the initial subscription, payments happen automatically.

### How Automatic Payments Work

<Steps>
  <Step title="Payment Becomes Due">
    Based on the billing interval (e.g., 30 days), the payment becomes due.
  </Step>
  
  <Step title="Our System Executes Payment">
    Our automated payment scheduler:
    - Detects due payments
    - Executes the on-chain transaction
    - Transfers funds from user's subscription wallet to your wallet
  </Step>
  
  <Step title="You Receive Webhook">
```json
    {
      "event": "subscription.payment_succeeded",
      "timestamp": 1703826567890,
      "data": {
        "subscriptionId": "ABC123...",
        "customer": {
          "email": "user@example.com",
          "walletAddress": "7xKXtg2..."
        },
        "userWallet": "6xKlsjj...",
        "amount": "9990000",
        "paymentNumber": 2,
        "nextPaymentDate": "2025-02-08T10:00:00Z"
      }
    }
```
  </Step>
  
  <Step title="Your System Extends Access">
```javascript
    if (event === 'subscription.payment_succeeded') {
      await db.users.update({
        id: userId,
        subscriptionPaidUntil: data.nextPaymentDate
      });
    }
```
  </Step>
</Steps>

### What If Payment Fails?

If a user's subscription wallet has insufficient balance:

1. **We retry automatically** (1 min, 5 min, 30 min intervals)
2. **You receive a webhook**:
```json
   {
     "event": "subscription.payment_failed",
     "data": {
       "subscriptionId": "ABC123...",
       "amountRequired": "9990000",
       "balanceAvailable": "2000000",
       "failureCount": 1
     }
   }
```
3. **You can notify the user** to add funds
4. **After 3 failures**, the subscription becomes inactive

---

## Subscription Lifecycle

<Frame>
  <img src="/images/subscription-lifecycle.png" alt="Subscription Lifecycle" />
</Frame>

### States

| State | Description | Your Action |
|-------|-------------|-------------|
| `active` | Subscription is active and payments are being processed | Provide access to services |
| `past_due` | Payment failed, in retry period | Show warning banner, prompt to add funds |
| `cancelled` | User cancelled subscription | Revoke access (optionally offer grace period) |
| `expired` | Payments failed 3 times | Revoke access, offer reactivation |

---

## Key Concepts

### Session vs Subscription

- **Checkout Session**: Temporary (30 min TTL), used for the checkout process
- **Subscription**: Permanent on-chain record, represents the active subscription

Once checkout completes, you work with the **subscription ID** (not session ID).

### Customer Identity

Every subscription links three identifiers:

1. **Email**: From your system, used for communication
2. **Customer ID**: Your internal user ID (optional)
3. **Wallet Address**: The user's Solana wallet (on-chain identifier)

This allows you to map blockchain subscriptions to your existing user database.

### Metadata

You can attach custom metadata to checkout sessions:
```javascript
metadata: {
  userId: '123',
  source: 'pricing_page',
  campaign: 'summer-sale-2024',
  referrer: 'twitter'
}
```

This metadata:
- Is included in all webhooks
- Helps you track conversions and sources
- Can store any JSON-serializable data

---

## Testing the Flow

<Note>
  Test on **Devnet** first before going live on Mainnet.
</Note>

1. Create a test plan in the dashboard
2. Use a devnet wallet as your merchant wallet
3. Create a checkout session with a test email
4. Download the Eventop app (in devnet mode)
5. Complete the checkout flow
6. Verify webhooks are received
7. Check that the subscription appears in your dashboard

See [Testing Guide](/merchants/testing) for detailed instructions.

---

## Next Steps

<CardGroup cols={2}>
  <Card title="Integration Guide" icon="code" href="/merchants/integration-guide">
    Step-by-step implementation tutorial
  </Card>
  <Card title="Webhook Reference" icon="webhook" href="/integration/webhooks">
    Complete webhook event documentation
  </Card>
  <Card title="API Reference" icon="book" href="/api-reference/checkout">
    Detailed API endpoint specs
  </Card>
  <Card title="Dashboard Guide" icon="chart-line" href="/merchants/dashboard">
    Manage subscriptions and view analytics
  </Card>
</CardGroup>